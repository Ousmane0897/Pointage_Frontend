<!-- ===================== FILTRES & L√âGENDE ===================== -->
<div class="flex flex-col lg:flex-row gap-6 p-4 bg-white rounded-xl shadow mb-4">

  <!-- Filtre agence -->
  <div class="flex items-center gap-3">
    <label class="font-semibold text-gray-700">Filtrer par agence :</label>
    <select [(ngModel)]="selectedSite" (change)="applyFilter()"
      class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
      <option value="">Toutes les agences</option>
      <option *ngFor="let site of availableSites" [value]="site">
        {{ site }}
      </option>
    </select>
  </div>

  <!-- L√©gende -->
  <div class="flex flex-wrap gap-4 text-sm text-gray-600">
    <div class="flex items-center gap-2">
      <span class="w-4 h-4 rounded-full bg-[#7E00DE]"></span> 06:00 - 19:00
    </div>
    <div class="flex items-center gap-2">
      <span class="w-4 h-4 rounded-full bg-[#545252]"></span> 06:00 - 10:00
    </div>
    <div class="flex items-center gap-2">
      <span class="w-4 h-4 rounded-full bg-[#FF9696]"></span> 15:00 - 19:00
    </div>
    <div class="flex items-center gap-2">
      <span class="w-4 h-4 rounded-full bg-[#D10000]"></span> Agent transf√©r√©
    </div>
  </div>
</div>

<!-- ===================== ALERTE AGENT D√âPLAC√â ===================== -->
<div *ngIf="isMobile"
  class="fixed top-6 right-6 z-50 max-w-sm bg-white border border-red-200 rounded-2xl shadow-xl p-5">

  <div class="flex gap-4">
    <div class="h-10 w-10 flex items-center justify-center rounded-xl bg-red-100 animate-pulse">
      ‚ö†Ô∏è
    </div>

    <div>
      <h3 class="font-semibold text-red-700">
        Alerte : Agents d√©plac√©s
      </h3>
      <p class="text-sm text-gray-600 mt-1">
        Un ou plusieurs agents ont √©t√© transf√©r√©s.
      </p>

      <div class="flex gap-2 mt-3">
        <button (click)="showDetails = true" class="px-3 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700">
          Voir d√©tails
        </button>
        <button (click)="isMobile = false" class="px-3 py-1.5 bg-gray-100 rounded-lg hover:bg-gray-200">
          Ignorer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== CALENDRIER ===================== -->
<div class="bg-white rounded-xl shadow p-4">
  <full-calendar [options]="calendarOptions"></full-calendar>
</div>

<!-- ===================== MENU CONTEXTUEL ===================== -->
<div [style.position]="'fixed'" [style.left]="menuPosition.x" [style.top]="menuPosition.y" [matMenuTriggerFor]="menu"
  #menuTrigger="matMenuTrigger">
</div>

<mat-menu #menu="matMenu" class="p-2 w-80">
  <div *ngIf="selectedEmploye" class="p-3">
    <h3 class="text-lg font-semibold">{{ selectedEmploye.name }}</h3>
    <p class="text-sm text-gray-600"><strong>Code :</strong> {{ selectedEmploye.codeEmploye }}</p>
    <p class="text-sm text-gray-600"><strong>Intervention :</strong> {{ selectedEmploye.intervention }}</p>
    <p class="text-sm text-gray-600"><strong>Statut :</strong> {{ selectedEmploye.statut }}</p>

    <button (click)="openAddModal()" class="mt-3 text-blue-600 hover:text-blue-800 text-2xl">
      ‚ûï Ajouter planification
    </button>
  </div>
</mat-menu>

<!-- ===================== MODAL AJOUT PLANIFICATION ===================== -->
<div *ngIf="showModal" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center">

  <div class="bg-white rounded-xl shadow-xl w-2/3 max-h-[90vh] overflow-y-auto p-6">

    <h2 class="text-xl font-semibold text-blue-600 mb-4">
      ‚ûï Ajouter une planification
    </h2>

    <form (ngSubmit)="saveModal(form)" #form="ngForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <div>
        <label class="font-medium">Code secret</label>
        <input [(ngModel)]="modalData.codeSecret" name="code" readonly class="w-full border rounded p-2 bg-gray-100" />
      </div>

      <div>
        <label class="font-medium">Agence actuelle</label>
        <input [(ngModel)]="modalData.nomSite" name="site" class="w-full border rounded p-2 bg-gray-100" readonly />
      </div>

      <div>
        <label class="font-medium">Agence de destination</label>
        <select [(ngModel)]="modalData.siteDestination[0]" (ngModelChange)="onSiteChange($event)"
          class="w-full border rounded p-2">
          <option *ngFor="let site of availableSites" [value]="site">{{ site }}</option>
        </select>
      </div>

      <div>
        <label class="font-medium">Agent remplac√©</label>
        <select [(ngModel)]="modalData.personneRemplacee" class="w-full border rounded p-2">
          <option *ngFor="let emp of employeesDansUnSite" [value]="emp.prenom + ' ' + emp.nom">
            {{ emp.prenom }} {{ emp.nom }}
          </option>
        </select>
      </div>

      <mat-form-field appearance="fill">
        <mat-label>Date de d√©but</mat-label>
        <input matInput [matDatepicker]="pickerDebut" [(ngModel)]="modalData.dateDebut" name="dateDebut">
        <mat-datepicker-toggle matSuffix [for]="pickerDebut"></mat-datepicker-toggle>
        <mat-datepicker #pickerDebut></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Date de fin</mat-label>
        <input matInput [matDatepicker]="pickerFin" [(ngModel)]="modalData.dateFin" name="dateFin">
        <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
        <mat-datepicker #pickerFin></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Heure d√©but</mat-label>
        <input matInput [ngxMatTimepicker]="startPicker" [(ngModel)]="modalData.heureDebut" name="heureDebut" readonly>
        <ngx-mat-timepicker #startPicker></ngx-mat-timepicker>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Heure fin</mat-label>
        <input matInput [ngxMatTimepicker]="endPicker" [(ngModel)]="modalData.heureFin" name="heureFin" readonly>
        <ngx-mat-timepicker #endPicker></ngx-mat-timepicker>
      </mat-form-field>

      <div class="md:col-span-2">
        <textarea [(ngModel)]="modalData.commentaires" class="w-full border rounded p-2" rows="4"
          placeholder="Commentaire..."></textarea>
      </div>

      <div class="md:col-span-2 flex justify-end gap-2">
        <button type="button" (click)="closeModal()" class="px-4 py-2 bg-gray-200 rounded">
          Annuler
        </button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">
          Ajouter
        </button>
      </div>

    </form>
  </div>
</div>

<!-- ===================== MODAL D√âTAILS AGENTS D√âPLAC√âS ===================== -->
<div *ngIf="showDetails" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center">

  <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full p-6">

    <h2 class="text-lg font-semibold mb-4">
      üìã Employ√©s transf√©r√©s
    </h2>

    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 text-left">Pr√©nom</th>
          <th class="p-2 text-left">Nom</th>
          <th class="p-2 text-left">Site origine</th>
          <th class="p-2 text-left">Site destination</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let emp of employesDeplaces" class="border-t">
          <td class="p-2">{{ emp.prenom }}</td>
          <td class="p-2">{{ emp.nom }}</td>
          <td class="p-2 text-green-700">{{ emp.siteAvantDeplacement }}</td>
          <td class="p-2 text-red-700">{{ emp.site }}</td>
        </tr>
      </tbody>
    </table>

    <div class="flex justify-end mt-4">
      <button (click)="close()" class="px-4 py-2 bg-gray-200 rounded">
        Fermer
      </button>
    </div>
  </div>
</div>