
<div class="flex gap-5">
<div class="p-4 flex items-center gap-4">
  <label for="department-select" class="font-semibold">Filtrer par agence :</label>
  <select id="department-select" [(ngModel)]="selectedSite" (change)="applyFilter()" class="border rounded p-1">
    <option value="">Tous les agences</option>
    <option *ngFor="let site of availableSites" [value]="site">{{ site }}</option>
  </select>
</div>
<div class="flex flex-col space-y-2">
  <div class="flex items-center gap-2">
    <div class="w-5 h-5 rounded-full" [style.backgroundColor]="'#7E00DE'"></div><p class="text-gray-600"> 06:00 - 19:00</p>
  </div>
  <div class="flex items-center gap-2">
    <div class="w-5 h-5 rounded-full" [style.backgroundColor]="'#545252'"></div> <p class="text-gray-600"> 06:00 - 10:00</p>
  </div>
  <div class="flex items-center gap-2">
    <div class="w-5 h-5 rounded-full" [style.backgroundColor]="'#FF9696'"></div> <p class="text-gray-600"> 15:00 - 19:00</p>
  </div>
  <div class="flex items-center gap-2">
    <div class="w-5 h-5 rounded-full" [style.backgroundColor]="'#D10000'"></div> <p class="text-gray-600"> agent transféré dans une autre agence.</p>
  </div>
</div>

<!-- Ex.: afficher si isImmobile === true -->
<div
  *ngIf="isMobile"
  class="fixed right-4 top-4 z-50 w-full max-w-sm rounded-2xl border border-red-200 bg-white/90 shadow-2xl backdrop-blur p-4 md:p-5"
  role="alert"
>
  <div class="flex items-start gap-3">
    <!-- Icône -->
    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-red-50 border border-red-200 animate-pulse">
      <!-- SVG inline (aucune lib requise) -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 9v2m0 4h.01M4.93 4.93l14.14 14.14M12 2a10 10 0 1010 10A10 10 0 0012 2z"/>
      </svg>
    </div>

    <div class="flex-1">
      <h3 class="font-semibold text-red-700">Alerte : Agent(s) déplacé(s)</h3>
      <p class="mt-1 text-sm text-gray-600">
        Un ou des déplacements d'agents ont été <span class="font-medium">détectés</span>.
      </p>

      <div class="mt-3 flex items-center gap-2">
        <button (click)="showDetails = true"
          class="rounded-xl px-3 py-1.5 text-sm font-medium bg-red-600 text-white hover:bg-red-700 active:scale-[.99] transition"
          
        >
          Voir détails
        </button>
        <button
          class="rounded-xl px-3 py-1.5 text-sm font-medium bg-gray-100 hover:bg-gray-200"
          (click)="isMobile = false"
        >
          Ignorer
        </button>
      </div>
    </div>
  </div>
</div>

</div>


<!-- Le calendrier -->
<full-calendar [options]="calendarOptions" class="p-4 max-w-full"></full-calendar>

<!-- Menu flottant type "carte" -->
<div [style.position]="'fixed'" [style.left]="menuPosition.x" [style.top]="menuPosition.y" [matMenuTriggerFor]="menu"
  #menuTrigger="matMenuTrigger">
</div>

<mat-menu #menu="matMenu" class="p-2 w-80">
  <div *ngIf="selectedEmploye" class="p-3 rounded-lg shadow-lg bg-white">
    <h3 class="text-lg font-semibold">{{ selectedEmploye.name }}</h3>
    <p class="text-sm text-gray-600"><strong>Code secret: </strong> {{ selectedEmploye?.codeEmploye }}</p>
    <p class="text-sm text-gray-600"><strong>Intervention: </strong> {{ selectedEmploye?.intervention }}</p>
    <p class="text-sm text-gray-600"><strong>Statut :</strong> {{ selectedEmploye?.statut }}</p>
    <div class="mt-2 flex gap-1">
      <button (click)="openAddModal()" class="text-blue-500 hover:text-blue-800 text-3xl">
        <i class="fa fa-plus-circle" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</mat-menu>

<!-- Modal d'ajout/modification -->

<!-- Overlay + Container -->
<div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 transition-opacity duration-300"
  [class.opacity-100]="modalVisible" [class.opacity-0]="!modalVisible" [class.hidden]="!showModal">
  <!-- Modal content -->
  <div
    class="max-h-[90vh] bg-white rounded-lg shadow-lg p-6 w-2/3 mx-auto transform transition-all duration-300 overflow-y-scroll"
    [class.scale-100]="modalVisible" [class.scale-90]="!modalVisible">
    <h2 class="text-xl text-blue-500 font-semibold mb-4">
         Ajouter une planification
    </h2>
    <form (ngSubmit)="saveModal(form)" #form="ngForm" novalidate>
      <input type="hidden" name="nomPrenom" [(ngModel)]="modalData.prenomNom" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4">
        <div class="mb-2">
          <label class="block mb-2 font-semibold text-gray-600">code secret</label>
          <input class="w-full p-2 border-2 rounded" [class.border-red-500]="code.invalid && code.touched" 
          name="code" #code="ngModel" placeholder="Entrer le code secret" [(ngModel)]="modalData.codeSecret" />
        </div>
        <div *ngIf="form.submitted && form.controls['code'].invalid" class="text-red-500 text-sm">
          Le code de création est requise.
        </div>


        <div class="mb-2">
          <label class="block mb-2 font-semibold text-gray-600">Agence actuelle</label>
          <input class="w-full p-2 border-2 rounded" [class.border-red-500]="adresseSite.invalid && adresseSite.touched"
            name="adresseSite" #adresseSite="ngModel" [(ngModel)]="modalData.nomSite" placeholder="L'adresse du site"
            required readonly />

        </div>

        <div class="mb-2">
            <label class="block mb-2 font-semibold text-gray-600">Agence de destination ➡️ </label>
          <select id="department-select" [(ngModel)]="modalData.siteDestination[0]"  (ngModelChange)="onSiteChange($event)" class="border rounded p-1">
            <option *ngFor="let site of availableSites" [value]="site">{{ site }}</option>
          </select>
        </div>

        <div *ngIf="modalData.siteDestination" class="mb-2">
          
          <label class="block mb-2 font-semibold text-gray-600">Agent à remplacer</label>
          <select id="department-select" [(ngModel)]="modalData.personneRemplacee" class="border rounded p-1">
            <option *ngFor="let emp of employeesDansUnSite" [value]="emp.prenom + ' ' + emp.nom">{{ emp.prenom + ' ' + emp.nom }}</option>
          </select>
        </div>

        <div class="mb-2">
          <mat-form-field appearance="fill" class="w-full ">
            <mat-label>Date de début</mat-label>
            <input matInput [matDatepicker]="pickerDebut" name="dateDebut" [(ngModel)]="modalData.dateDebut">
            <mat-datepicker-toggle matSuffix [for]="pickerDebut"></mat-datepicker-toggle>
            <mat-datepicker #pickerDebut></mat-datepicker>
          </mat-form-field>
        </div>
        <div *ngIf="form.submitted && form.controls['dateDebut'].invalid" class="text-red-500 text-sm">
          La date de début est requise.
        </div>
        <div class="mb-2">
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Date de fin</mat-label>
            <input matInput [matDatepicker]="pickerFin" name="dateFin" [(ngModel)]="modalData.dateFin">
            <mat-datepicker-toggle matSuffix [for]="pickerFin"></mat-datepicker-toggle>
            <mat-datepicker #pickerFin></mat-datepicker>
          </mat-form-field>
        </div>
        <div *ngIf="form.submitted && form.controls['dateFin'].invalid" class="text-red-500 text-sm">
          La date de fin est requise.
        </div>

        <mat-form-field appearance="outline" class="w-full mb-2">
          <mat-label>Heure de début</mat-label>
          <input matInput [ngxMatTimepicker]="startPicker" [format]="24" [(ngModel)]="modalData.heureDebut" readonly
            placeholder="Sélectionner l'heure" name="heureDebut" #heureDebut="ngModel" />
          <ngx-mat-timepicker #startPicker></ngx-mat-timepicker>
        </mat-form-field>


        <mat-form-field appearance="outline" class="w-full mb-2">
          <mat-label>Heure de fin</mat-label>
          <input matInput [ngxMatTimepicker]="endPicker" [format]="24" [(ngModel)]="modalData.heureFin" readonly
            placeholder="Sélectionner l'heure" name="heureFin" #heureFin="ngModel" />
          <ngx-mat-timepicker #endPicker></ngx-mat-timepicker>

        </mat-form-field>

        <div *ngIf=" (heureDebut.touched && heureDebut.invalid) || (heureFin.touched && heureFin.invalid)"
          class="text-sm text-red-500">
          Les heures de début et de fin sont requises.
        </div>

        <div class="mb-2">
          <textarea class="w-full p-2 border-2  rounded" [(ngModel)]="modalData.commentaires" rows="5" cols="30"
            placeholder="Entrez un commentaire..." #commentaires="ngModel"></textarea>
        </div>

        <div class="mb-2">
          <mat-form-field appearance="fill" class="w-full ">
            <mat-label>Date de Création</mat-label>
            <input matInput [matDatepicker]="pickerCreation" name="dateCreation" [(ngModel)]="modalData.dateCreation">
            <mat-datepicker-toggle matSuffix [for]="pickerCreation"></mat-datepicker-toggle>
            <mat-datepicker #pickerCreation></mat-datepicker>
          </mat-form-field>
        </div>
        <div *ngIf="form.submitted && form.controls['dateCreation'].invalid" class="text-red-500 text-sm">
          La date de création est requise.
        </div>
      </div>
      <div class="flex justify-end space-x-2">
        <button type="button" class="bg-gray-500 hover:bg-gray-800 text-white px-4 py-2 rounded"
          (click)="closeModal()">Annuler</button>

        <button type="submit" class="bg-blue-500 hover:bg-blue-800 text-white px-4 py-2 rounded">
              Ajouter
        </button>
      </div>
    </form>

  </div>
</div>

<!-- Modal -->
<div *ngIf="showDetails" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
  <!-- Container -->
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 animate-fadeIn">
    
    <!-- Header -->
    <div class="flex justify-between items-center border-b px-6 py-4">
      <h2 class="text-lg font-semibold text-gray-800"> Les employés transférés</h2>
    </div>
    
   <div class="overflow-x-auto">
            <table
                class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-md overflow-hidden shadow-sm">
                <thead class="bg-gray-100 text-gray-700 text-sm font-semibold">
                    <tr>
                      
                        <th class="px-4 py-2 text-left">Prénom</th>
                        <th class="px-4 py-2 text-left">Nom</th>
                        <th class="px-4 py-2 text-left">site d'origine</th>
                        <th class="px-4 py-2 text-left">site de destination</th>
                        
                        <!--<th class="px-4 py-2 text-left">Heures début - fin</th>-->
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 bg-white text-sm text-gray-700">
                    <tr *ngFor="let emp of employesDeplaces" class="hover:bg-gray-50 transition-colors">
                    
                        <td class="px-4 py-2">{{ emp.prenom }}</td>
                        <td class="px-4 py-2">{{ emp.nom }}</td>
                        <td class="  text-green-800 rounded-full text-sm items-center justify-center">{{ emp.siteAvantDeplacement }}</td>
                        <td class="  text-red-800 rounded-full text-sm items-center justify-center">{{ emp.site }}</td>
                        
                    </tr>
                </tbody>
            </table>

        </div>
    
    <!-- Footer -->
    <div class="flex justify-end border-t px-6 py-4">
      <button (click)="close()" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700">
        Fermer
      </button>
    </div>
  </div>
</div>
