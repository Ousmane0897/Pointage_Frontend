<div class="p-6 bg-white rounded-lg shadow">
  <h2 class="text-xl font-semibold mb-4">üì¶ Suivi des commandes de {{ moisNomComplet }}</h2>

  <div *ngIf="loading" class="text-gray-500">Chargement...</div>

  <div *ngIf="!loading && demandes.length === 0" class="text-gray-500 text-xl justify-center items-center">Aucune
    commande de produits pour le moment.</div>


  <table class="w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2">Destination</th>
        <th class="p-2">Superviseur</th>
        <th class="p-2">Date</th>
        <th class="p-2">Statut</th>
        <th class="p-2">Date de livraison</th>
        <th class="p-2">Heure de livraison</th>
        <th class="p-2" *ngIf="role !== 'SUPERVISEUR'">Actions</th>
        <th *ngIf="role == 'SUPERADMIN'" class="p-2"> Qui a modifi√© ?</th>
      </tr> 
    </thead>
    <tbody>
      <ng-container *ngFor="let d of demandes">
        <tr [ngClass]="getRowClass(d)">

          <td class="p-2 text-center">{{ d.destination }}</td>
          <td class="p-2 text-center">{{ d.responsable }}</td>
          <td class="p-2 text-center">{{ d.dateDemande }}</td>
          <td class="p-2 text-center">
            <span [ngClass]="{
        'px-4 py-2 rounded-lg bg-yellow-100 text-yellow-800': d.statut === 'EN_ATTENTE',
        'px-4 py-2 rounded-lg bg-orange-100 text-orange-800': d.statut === 'EN_COURS',
        'px-4 py-2 rounded-lg bg-green-100 text-green-800': d.statut === 'LIVREE'
      }">
              {{ d.statut }}
            </span>
          </td>
          <td class="p-2 text-center">{{ d.dateLivraison || 'Indisponible' }}</td>
          <td class="p-2 text-center">{{ d.heureLivraison || 'Indisponible' }}</td>
          <td *ngIf="role !== 'SUPERVISEUR'" class="p-2 text-center">
            <button class="text-blue-600" [disabled]="d.statut !== 'EN_ATTENTE'" (click)="ouvrirEdition(d)">
              √âditer
            </button>
            <span class="mx-2">|</span>

            <button class="text-green-600" [disabled]="d.statut !== 'EN_COURS' && role === 'EXPLOITATION' || role === 'BACKOFFICE' || role === 'SUPERADMIN'" (click)="marquerLivree(d)">
              Marquer comme livr√©e
            </button>
          </td>

          <td *ngIf="role === 'SUPERADMIN'" class="p-2 text-center">
            <button class="p-2 text-red-600" (click)="afficherHistorique(d)">
              Voir les modifications
            </button>
          </td>

        </tr>
      </ng-container>

      <!-- ‚≠ê Message affich√© si aucune des conditions n'est remplie -->
      <tr *ngIf="aucuneCommandeDisponible && role !== 'SUPERVISEUR'">
        <td colspan="6" class="text-center py-4 text-gray-600 font-semibold">
          Commandes de produits pas encore disponible pour ce mois.
        </td>
      </tr>

    </tbody>
  </table>
</div>



<!-- Modal simple d'√©dition -->
<div *ngIf="showEditModal"
     class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">

  <div class="bg-white rounded-lg p-6 w-full max-w-4xl shadow-lg">
    <h3 class="text-lg font-semibold mb-4">Modifier la demande</h3>

    <form [formGroup]="editForm" (ngSubmit)="sauvegarderEdition()">

      <!-- üü© TITRES DES COLONNES -->
      <div class="grid grid-cols-2 gap-6 mb-4">
        <h4 class="font-semibold text-center text-gray-600">Donn√©es d‚Äôorigine</h4>
        <h4 class="font-semibold text-center text-gray-600">Donn√©es modifiables</h4>
      </div>

      <!-- üü¶ INFOS PRINCIPALES (destination / responsable) -->
      <div class="grid grid-cols-2 gap-6">

        <!-- üîπ Gauche : readonly -->
        <div class="grid grid-cols-1 gap-4">
          <input [value]="ancienneDemande?.destination"
                 class="p-2 border rounded bg-gray-100"
                 readonly />
          <input [value]="ancienneDemande?.responsable"
                 class="p-2 border rounded bg-gray-100"
                 readonly />
        </div>

        <!-- üîπ Droite : modifiable -->
        <div class="grid grid-cols-1 gap-4">
          <input formControlName="destination"
                 class="p-2 border rounded" />
          <input formControlName="responsable"
                 class="p-2 border rounded" />
        </div>

      </div>

      <!-- üü¶ PRODUITS -->
      <div class="mt-6 grid grid-cols-2 gap-6">

        <!-- üîπ GAUCHE : produits d‚Äôorigine -->
        <div>
          <div class="font-medium mb-2 text-gray-600">Produits d‚Äôorigine</div>

          <div *ngFor="let p of ancienneDemande?.anciensProduitsDemandes"
               class="flex gap-2 mb-2">

            <input [value]="p.nomProduit"
                   class="border p-2 rounded w-2/3 bg-gray-100"
                   readonly />

            <input [value]="p.quantite"
                   class="border p-2 rounded w-1/4 bg-gray-100"
                   readonly />
          </div>
        </div>

        <!-- üîπ DROITE : produits modifiables -->
        <div formArrayName="produitsDemandes">
          <div class="font-medium mb-2 text-gray-600">Produits modifiables</div>

          <div *ngFor="let group of produits.controls; let i = index"
               [formGroupName]="i"
               class="flex gap-2 items-center mb-2">

            <input formControlName="nomProduit"
                   class="border p-2 rounded w-2/3" />

            <input formControlName="quantite"
                   type="number"
                   class="border p-2 rounded w-1/4" />

            <button type="button" class="text-red-600" (click)="supprimerProduit(i)">‚ùå</button>
          </div>

          <button type="button"
                  class="mt-2 px-3 py-1 bg-gray-200 rounded"
                  (click)="ajouterProduitDefault()">
            + Ajouter produit
          </button>
        </div>

      </div>

      <!-- BUTTONS -->
      <div class="mt-6 flex justify-end gap-2">
        <button type="button"
                class="px-4 py-2 bg-gray-200 rounded"
                (click)="fermerModal()">
          Annuler
        </button>
        <button type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded">
          Enregistrer
        </button>
      </div>
    </form>
  </div>

</div>



<!-- Historique des modifications -->
<div *ngIf="showHistoryModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-2xl shadow-lg">
    <h3 class="text-lg font-semibold mb-4">Historique des modifications</h3>

    <div *ngIf="modificationHistory.length > 0; else noHistory">
      <ul class="list-disc list-inside space-y-2">
        <li *ngFor="let entry of modificationHistory">{{ "D√©tails : " + entry }}</li>
      </ul>
    </div>
    <ng-template #noHistory>
      <p>Aucune modification enregistr√©e.</p>
    </ng-template>

    <div class="mt-4 flex justify-end">
      <button type="button" class="px-4 py-2 bg-gray-200 rounded" (click)="showHistoryModal = false">Fermer</button>
    </div>
  </div>
</div>